<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Straddle Royale V2</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #1a1a2e; --panel: #16213e; --red: #e94560; --yellow: #f1c40f; --green: #2ecc71; --white: #fff; }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; height: 100vh; background: var(--bg); color: var(--white); font-family: 'Roboto', sans-serif; display: flex; overflow: hidden; }

        /* SIDEBAR */
        #sidebar { width: 350px; background: var(--panel); border-right: 2px solid #000; display: flex; flex-direction: column; padding: 20px; z-index: 20; box-shadow: 5px 0 20px #000; }
        .logo { font-family: 'Anton', sans-serif; font-size: 42px; color: var(--red); line-height: 1; margin-bottom: 20px; text-shadow: 2px 2px #000; }
        
        .code-box { background: #000; border: 2px dashed var(--yellow); padding: 15px; text-align: center; margin-bottom: 20px; border-radius: 8px; }
        .code-val { font-family: 'Anton', sans-serif; font-size: 48px; color: var(--yellow); margin-top: 5px; letter-spacing: 3px; }
        
        #player-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        /* CARDS */
        .player-card { background: #252f4e; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 12px; border: 3px solid transparent; transition: 0.1s; }
        .player-card.clickable { cursor: pointer; }
        .player-card.clickable:hover { background: #3a4b7c; border-color: rgba(255,255,255,0.3); }
        .player-card.active { border-color: var(--green); background: #1e3a2a; }
        .player-card.target { border-color: var(--red) !important; background: #5c1818 !important; }
        .player-card.dead { opacity: 0.4; filter: grayscale(1); }

        .avatar { width: 50px; height: 50px; border-radius: 8px; background: #000; border: 2px solid #000; pointer-events: none; }
        .hp-dot { width: 12px; height: 12px; background: #333; border-radius: 50%; border: 1px solid #000; display: inline-block; margin-right: 4px; }
        .hp-dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); }

        /* ARENA */
        #arena { flex-grow: 1; position: relative; background: radial-gradient(circle, #232342 0%, #1a1a2e 80%); display: flex; justify-content: center; align-items: center; }
        
        #top-bar { position: absolute; top: 20px; background: rgba(0,0,0,0.7); padding: 10px 30px; border-radius: 30px; font-weight: bold; border: 1px solid #555; font-size: 1.2rem; z-index: 10; }

        .arena-p { position: absolute; display: flex; flex-direction: column; align-items: center; width: 120px; transition: transform 0.5s; z-index: 5; margin-left: -60px; margin-top: -60px; }
        .arena-av { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #333; background: #000; transition: 0.2s; pointer-events: none; }
        
        .arena-p.clickable { cursor: pointer; }
        .arena-p.clickable:hover .arena-av { transform: scale(1.1); border-color: #fff; }
        .arena-p.active .arena-av { border-color: var(--green); box-shadow: 0 0 25px var(--green); transform: scale(1.1); }
        .arena-p.target .arena-av { border-color: var(--red); box-shadow: 0 0 35px var(--red); animation: shake 0.5s infinite; }
        
        .arena-name { background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 4px; margin-top: 5px; font-weight: bold; pointer-events: none; }

        /* CONTROLS */
        #action-area { position: absolute; bottom: 40px; right: 40px; z-index: 50; }
        .btn-big { width: 90px; height: 90px; border-radius: 50%; border: 4px solid #fff; background: var(--red); color: #fff; font-size: 40px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 20px #000; transition: 0.2s; }
        .btn-big:hover { transform: scale(1.1); background: #ff6b81; }
        .btn-big:disabled { background: #555; border-color: #777; opacity: 0; pointer-events: none; }

        /* MODALS */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #fff; color: #000; padding: 40px; border-radius: 8px; width: 400px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #000; font-size: 1.2rem; text-align: center; font-weight: bold; text-transform: uppercase; }
        .btn-main { width: 100%; padding: 15px; background: #000; color: #fff; font-weight: bold; cursor: pointer; font-size: 1.2rem; margin-top: 10px; }
        .btn-main:hover { background: var(--red); }

        #console { position: absolute; bottom: 0; left: 0; width: 100%; height: 25px; background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 4px; opacity: 0.6; pointer-events: none; z-index: 999; }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .floater { position: absolute; font-size: 40px; font-weight: 900; animation: float 2s forwards; pointer-events: none; text-shadow: 2px 2px #000; z-index: 100; }
        @keyframes float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo">STRADDLE<br>ROYALE</div>
        <div class="code-box">
            <div style="color:#888; font-size:12px;">ROOM CODE</div>
            <div class="code-val" id="room-disp">----</div>
        </div>
        <div id="player-list"></div>
    </div>

    <div id="arena">
        <div id="top-bar">CONNECTING...</div>
        <div id="arena-layer"></div>
        <div id="action-area">
            <button id="btn-act" class="btn-big" disabled onclick="confirmAction()">✓</button>
        </div>
    </div>

    <div id="console">System Ready. v11 Stable.</div>

    <!-- SETUP -->
    <div id="setup" class="modal-wrap">
        <div class="modal">
            <h1 style="margin:0 0 20px 0; font-family:'Anton'; font-size:40px;">WELCOME</h1>
            <input type="text" id="my-name" placeholder="NAME" maxlength="10">
            <input type="text" id="my-av" placeholder="AVATAR URL (OPTIONAL)">
            <button class="btn-main" onclick="start('HOST')">HOST GAME</button>
            <button class="btn-main" style="background:#555" onclick="showJoin()">JOIN GAME</button>
        </div>
    </div>

    <div id="join" class="modal-wrap hidden">
        <div class="modal">
            <h1>JOIN ROOM</h1>
            <input type="text" id="join-code" placeholder="ABCD">
            <button class="btn-main" onclick="start('JOIN')">CONNECT</button>
            <button class="btn-main" style="background:#ccc; color:#000" onclick="location.reload()">BACK</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const TOPIC_ROOT = 'straddle-stable-v11/';

        // --- STATE ---
        let client;
        let myId = Math.random().toString(36).substr(2, 8);
        let myName = "Player";
        let myAvatar = "";
        let roomCode = "";
        let isHost = false;

        // Synced State
        let players = [];
        let turnIndex = 0;
        let phase = "LOBBY";
        let targetedId = null; // Who is currently being targeted (Global)

        // Local State
        let lastRenderState = ""; // For Diffing (Prevents Thrashing)
        let heartbeatTimer;
        let retryTimer;

        function log(t) { document.getElementById('console').innerText = `> ${t}`; console.log(t); }
        function showJoin() { document.getElementById('setup').classList.add('hidden'); document.getElementById('join').classList.remove('hidden'); }

        function start(mode) {
            myName = document.getElementById('my-name').value.trim() || "Warrior";
            myAvatar = document.getElementById('my-av').value.trim() || `https://api.dicebear.com/9.x/bottts/svg?seed=${myId}`;

            if (mode === 'HOST') {
                isHost = true;
                roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                players = [{id: myId, name: myName, avatar: myAvatar, hp: 3, dead: false}];
            } else {
                roomCode = document.getElementById('join-code').value.trim().toUpperCase();
                if (roomCode.length < 4) return alert("Invalid Code");
            }

            document.getElementById('setup').classList.add('hidden');
            document.getElementById('join').classList.add('hidden');
            document.getElementById('room-disp').innerText = roomCode;
            
            connect();
        }

        function connect() {
            log("Connecting...");
            client = mqtt.connect(BROKER);
            client.on('connect', () => {
                log("Connected. Subscribing...");
                client.subscribe(TOPIC_ROOT + roomCode);
                
                if (isHost) {
                    heartbeatTimer = setInterval(sendState, 1000); // 1s Heartbeat
                    render();
                } else {
                    // Client Retry Logic
                    send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                    retryTimer = setInterval(() => {
                        // If we aren't in the player list yet, keep knocking
                        if (!players.find(p => p.id === myId)) {
                            log("Knocking...");
                            send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                        } else {
                            clearInterval(retryTimer);
                            log("Joined!");
                        }
                    }, 2000);
                }
            });

            client.on('message', (t, m) => {
                try {
                    const d = JSON.parse(m.toString());
                    if (d.sender !== myId) handle(d);
                } catch (e) {}
            });
        }

        function send(d) {
            d.sender = myId;
            client.publish(TOPIC_ROOT + roomCode, JSON.stringify(d));
        }

        function handle(d) {
            if (isHost) {
                if (d.type === 'JOIN') {
                    if (!players.find(p => p.id === d.id)) {
                        players.push({ id: d.id, name: d.name, avatar: d.avatar, hp: 3, dead: false });
                        log(`${d.name} Joined`);
                        sendState(); // Instant update
                    }
                } 
                else if (d.type === 'TARGET') {
                    targetedId = d.targetId;
                    sendState();
                }
                else if (d.type === 'ATTACK') {
                    resolveCombat(d.sender, d.targetId);
                }
            } else {
                // Client
                if (d.type === 'STATE') {
                    players = d.players;
                    turnIndex = d.turnIndex;
                    phase = d.phase;
                    targetedId = d.targetedId;
                    render(); // Render uses diffing, so safe to call often
                }
                else if (d.type === 'FX') {
                    showFloat(d.targetId, d.text, d.color);
                }
            }
        }

        function sendState() {
            send({ type: 'STATE', players, turnIndex, phase, targetedId });
            render();
        }

        // --- ACTIONS ---

        function clickPlayer(id) {
            if (phase !== 'IDLE') return;
            const turnP = players[turnIndex];
            if (!turnP || turnP.id !== myId) return; // Not my turn
            if (id === myId) return; // Self
            
            const t = players.find(p => p.id === id);
            if (!t || t.dead) return;

            // Set target locally AND tell host (so everyone sees the red ring)
            targetedId = id;
            
            if (isHost) sendState();
            else send({ type: 'TARGET', targetId: id });
            
            render(); // Instant local feedback
        }

        function confirmAction() {
            if (isHost && phase === 'LOBBY') {
                if (players.length < 2) return alert("Need 2 players");
                phase = 'IDLE';
                sendState();
                return;
            }

            if (phase === 'GAMEOVER') {
                location.reload();
                return;
            }

            if (phase === 'IDLE' && targetedId) {
                if (isHost) resolveCombat(myId, targetedId);
                else send({ type: 'ATTACK', targetId: targetedId });
                
                phase = 'ROLLING'; // Optimistic
                render();
            }
        }

        function resolveCombat(attId, defId) {
            const current = players[turnIndex];
            if (current.id !== attId) return; // Security check

            phase = 'ROLLING';
            targetedId = defId; // Ensure sync
            sendState();

            const r1 = Math.floor(Math.random()*20)+1;
            const r2 = Math.floor(Math.random()*20)+1;
            let hit = r1 > r2;

            setTimeout(() => {
                if (hit) {
                    const def = players.find(p => p.id === defId);
                    if (def) {
                        def.hp--;
                        if (def.hp<=0) { def.hp=0; def.dead=true; }
                    }
                    send({ type: 'FX', targetId: defId, text: "HIT! -1", color: '#e94560' });
                    showFloat(defId, "HIT! -1", '#e94560');
                } else {
                    send({ type: 'FX', targetId: defId, text: "BLOCKED", color: '#fff' });
                    showFloat(defId, "BLOCKED", '#fff');
                }
            }, 1000);

            setTimeout(() => {
                targetedId = null; // Clear target
                const alive = players.filter(p => !p.dead);
                if (alive.length === 1) phase = 'GAMEOVER';
                else {
                    let i=0;
                    do { turnIndex = (turnIndex+1)%players.length; i++; }
                    while(players[turnIndex].dead && i<20);
                    phase = 'IDLE';
                }
                sendState();
            }, 3000);
        }

        // --- RENDERER (WITH DIFFING) ---
        function render() {
            // 1. Create State Hash
            const currentState = JSON.stringify({ players, turnIndex, phase, targetedId, myId });
            if (currentState === lastRenderState) return; // NOTHING CHANGED, DO NOT TOUCH DOM
            lastRenderState = currentState;

            const list = document.getElementById('player-list');
            const arena = document.getElementById('arena-layer');
            const bar = document.getElementById('top-bar');
            const btn = document.getElementById('btn-act');

            list.innerHTML = '';
            arena.innerHTML = '';

            const turnP = players[turnIndex] || {};
            const isMyTurn = turnP.id === myId;

            // UI State
            if (phase === 'LOBBY') {
                bar.innerText = `LOBBY: ${players.length} WARRIORS`;
                btn.innerHTML = "▶";
                btn.disabled = !isHost;
                btn.style.opacity = isHost ? 1 : 0.5;
            } else if (phase === 'GAMEOVER') {
                const w = players.find(p => !p.dead);
                bar.innerText = `WINNER: ${w?w.name:'NONE'}`;
                btn.innerHTML = "↺";
                btn.disabled = false;
                btn.style.opacity = 1;
                btn.onclick = () => location.reload();
            } else if (phase === 'ROLLING') {
                bar.innerText = "ROLLING DICE...";
                btn.disabled = true;
                btn.style.opacity = 0;
            } else {
                // IDLE
                if (isMyTurn) {
                    bar.innerText = targetedId ? "CLICK CHECK TO FIRE" : "YOUR TURN - SELECT TARGET";
                    bar.style.color = targetedId ? "#f1c40f" : "#2ecc71";
                    btn.innerHTML = "✓";
                    btn.disabled = !targetedId;
                    btn.style.opacity = targetedId ? 1 : 0.3;
                } else {
                    bar.innerText = `${turnP.name}'S TURN`;
                    bar.style.color = "#fff";
                    btn.disabled = true;
                    btn.style.opacity = 0;
