<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Straddle Royale V6</title>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-overlay: rgba(0, 0, 0, 0.4); /* Lighter overlay to see the room */
            --panel-bg: rgba(15, 15, 20, 0.95);
            --highlight: #e94560;
            --accent: #f1c40f;
            --text-main: #ffffff;
            --green: #2ecc71;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            height: 100vh;
            /* IMAGE: Uploaded the one I made */
            background-image: url('https://i.imgur.com/2jHImDs.png'); 
            background-size: cover;
            background-position: center;
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            display: flex;
        }

        body::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-overlay); z-index: -1;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 350px;
            background: var(--panel-bg);
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 20;
            box-shadow: 10px 0 30px #000;
        }

        .logo {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            color: var(--highlight);
            text-transform: uppercase;
            line-height: 1;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 #000;
            text-align: center;
        }

        /* CODE BOX */
        .code-box {
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.2s;
        }
        .code-box:hover { border-color: var(--accent); }
        
        .code-val { 
            font-family: 'Anton', sans-serif; 
            font-size: 32px; 
            color: var(--accent); 
            letter-spacing: 2px; 
        }
        .copy-hint { font-size: 10px; color: #777; margin-top: 2px; }

        /* PLAYER LIST */
        #player-list {
            flex-grow: 1; /* Takes up available space */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            padding-right: 5px; /* Space for scrollbar */
        }

        /* BATTLE LOG (New!) */
        #battle-log {
            height: 200px;
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            color: #aaa;
            display: flex;
            flex-direction: column-reverse; /* Newest at bottom visually, handled by prepend */
        }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #222; padding-bottom: 4px; }
        .log-high { color: var(--highlight); font-weight: bold; }
        .log-good { color: var(--green); }
        .log-neut { color: #888; }

        /* PLAYER CARDS */
        .player-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid transparent;
            transition: 0.1s;
        }
        .player-card.clickable:hover { background: rgba(255, 255, 255, 0.15); cursor: pointer; border-color: #fff; }
        .player-card.active { border-color: var(--green); background: rgba(46, 204, 113, 0.1); }
        .player-card.target { border-color: var(--highlight) !important; background: rgba(233, 69, 96, 0.2) !important; }
        .player-card.dead { opacity: 0.4; filter: grayscale(1); }
        .player-card.stunned { border-color: #a29bfe; }

        /* AVATAR FIX: Object-fit Cover prevents stretching */
        .avatar { 
            width: 45px; height: 45px; 
            border-radius: 6px; 
            background: #000; 
            border: 1px solid #555; 
            pointer-events: none; 
            object-fit: cover; /* CRITICAL FIX */
        }
        
        .card-info { flex-grow: 1; pointer-events: none; }
        .card-name { font-weight: 700; font-size: 14px; }
        
        .hp-container { display: flex; gap: 4px; margin-top: 4px; }
        .hp-dot { width: 10px; height: 10px; background: #222; border-radius: 50%; border: 1px solid #444; }
        .hp-dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); border-color: var(--green); }

        .status-badge { font-size: 9px; padding: 2px 4px; border-radius: 3px; background: #a29bfe; color: #000; font-weight: bold; margin-left: 5px; display: none; }
        .stunned .status-badge { display: inline-block; }

        /* ARENA */
        #arena { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        
        #top-bar {
            position: absolute; top: 20px;
            background: rgba(0,0,0,0.8); padding: 8px 25px;
            border-radius: 30px; font-weight: bold; border: 1px solid #555;
            font-size: 1.2rem; z-index: 10; box-shadow: 0 5px 15px #000;
        }

        /* ROLL TEXT OVERLAY */
        #roll-display {
            position: absolute; top: 15%; width: 80%; text-align: center;
            font-family: 'Anton', sans-serif; font-size: 56px; color: var(--accent);
            text-shadow: 0 4px 10px #000; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }
        #roll-display.visible { opacity: 1; }
        .roll-sub { display: block; font-family: 'Roboto'; font-size: 20px; color: #fff; margin-top: 5px; font-weight: normal; text-shadow: 0 2px 4px #000; }

        .arena-p {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            width: 120px; transition: transform 0.5s; z-index: 5; margin-left: -60px; margin-top: -60px;
        }
        
        /* ARENA AVATAR FIX */
        .arena-av {
            width: 110px; height: 110px; border-radius: 50%; border: 4px solid #333;
            background: #000; transition: 0.2s; pointer-events: none; box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            object-fit: cover; /* CRITICAL FIX */
        }
        
        .arena-p.clickable:hover .arena-av { transform: scale(1.1); border-color: #fff; cursor: pointer; }
        .arena-p.active .arena-av { border-color: var(--green); box-shadow: 0 0 30px var(--green); transform: scale(1.1); }
        .arena-p.target .arena-av { border-color: var(--highlight); box-shadow: 0 0 40px var(--highlight); animation: shake 0.5s infinite; }
        .arena-p.dead { opacity: 0; transition: opacity 1s; pointer-events: none; }

        .arena-name {
            background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 4px;
            margin-top: 8px; font-weight: bold; pointer-events: none;
            box-shadow: 0 2px 5px #000;
        }

        /* CONTROLS */
        #action-area { position: absolute; bottom: 40px; right: 40px; z-index: 50; }
        .btn-big {
            width: 100px; height: 100px; border-radius: 50%; border: 5px solid #fff;
            background: var(--highlight); color: #fff; font-size: 50px; font-weight: bold;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: 0.2s;
        }
        .btn-big:hover { transform: scale(1.1); background: #ff6b81; }
        .btn-big:disabled { background: #555; border-color: #777; opacity: 0; pointer-events: none; }

        /* MODALS */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #fff; color: #000; padding: 40px; border-radius: 8px; width: 450px; text-align: center; position: relative; box-shadow: 0 0 50px #000; }
        .close-modal { position: absolute; top: 10px; right: 15px; cursor: pointer; font-size: 24px; font-weight: bold; }
        
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #000; font-size: 1.2rem; text-align: center; font-weight: bold; text-transform: uppercase; }
        .btn-main { width: 100%; padding: 15px; background: #000; color: #fff; font-weight: bold; cursor: pointer; font-size: 1.2rem; margin-top: 10px; }
        .btn-main:hover { background: var(--highlight); }

        #console { position: absolute; bottom: 0; left: 0; width: 100%; height: 25px; background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 4px; opacity: 0.6; pointer-events: none; z-index: 999; }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .floater { position: absolute; font-size: 40px; font-weight: 900; animation: float 2s forwards; pointer-events: none; text-shadow: 2px 2px #000; z-index: 100; white-space: nowrap; }
        @keyframes float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }
        
        .hidden { display: none !important; }
        .rules-list { text-align: left; margin: 20px 0; line-height: 1.5; font-size: 13px;}
        .rules-list li { margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 2px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo">STRADDLE<br>ROYALE V6</div>
        
        <div class="code-box" onclick="copyRoomCode()">
            <div style="color:#888; font-size:12px;">ROOM CODE (CLICK TO COPY)</div>
            <div class="code-val" id="room-disp">----</div>
            <div class="copy-hint" id="copy-msg"></div>
        </div>

        <div id="player-list"></div>
        
        <div id="battle-log">
            <div class="log-neut">System Ready...</div>
        </div>

        <button class="btn-main" style="background:transparent; border:1px solid #555; color:#aaa; margin-top:10px; padding: 10px; font-size: 14px;" onclick="toggleHelp()">RULES</button>
    </div>

    <div id="arena">
        <div id="top-bar">INITIALIZING...</div>
        <div id="roll-display"></div>
        <div id="arena-layer"></div>
        <div id="action-area">
            <button id="btn-act" class="btn-big" disabled onclick="confirmAction()">✓</button>
        </div>
    </div>

    <div id="console">System Ready. V6 Final.</div>

    <!-- SETUP -->
    <div id="setup" class="modal-wrap">
        <div class="modal">
            <h1 style="margin:0 0 20px 0; font-family:'Anton'; font-size:40px;">WELCOME</h1>
            <input type="text" id="my-name" placeholder="NAME" maxlength="10">
            <input type="text" id="my-av" placeholder="AVATAR URL (OPTIONAL)">
            <button class="btn-main" onclick="start('HOST')">HOST GAME</button>
            <button class="btn-main" style="background:#555" onclick="showJoin()">JOIN GAME</button>
        </div>
    </div>

    <div id="join" class="modal-wrap hidden">
        <div class="modal">
            <h1>JOIN ROOM</h1>
            <input type="text" id="join-code" placeholder="ABCD">
            <button class="btn-main" onclick="start('JOIN')">CONNECT</button>
            <button class="btn-main" style="background:#ccc; color:#000" onclick="location.reload()">BACK</button>
        </div>
    </div>

    <div id="help" class="modal-wrap hidden">
        <div class="modal">
            <div class="close-modal" onclick="toggleHelp()">×</div>
            <h2>RULES</h2>
            <ul class="rules-list">
                <li><strong>1-40:</strong> Target -1 HP (Hit)</li>
                <li><strong>41-70:</strong> You -1 HP (Backfire)</li>
                <li><strong>71-80:</strong> Miss (No Effect)</li>
                <li><strong>81-85:</strong> Target -2 HP (Enhanced)</li>
                <li><strong>86-90:</strong> You -2 HP (Bad Luck)</li>
                <li><strong>91-95:</strong> BOTH -2 HP (Mutual)</li>
                <li><strong>96:</strong> Stun Target (Skip Turn)</li>
                <li><strong>97:</strong> Stun Self (Skip Turn)</li>
                <li><strong>98:</strong> Drain Life (Heal)</li>
                <li><strong>99:</strong> Steal HP (-1 Them, +1 You)</li>
                <li><strong>100:</strong> Adrenaline (Hit + Go Again)</li>
            </ul>
            <button class="btn-main" onclick="toggleHelp()">GOT IT</button>
        </div>
    </div>

    <script>
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const TOPIC_ROOT = 'straddle-v6-final/';

        let client;
        let myId = Math.random().toString(36).substr(2, 8);
        let myName = "Player";
        let myAvatar = "";
        let roomCode = "";
        let isHost = false;

        let players = [];
        let turnIndex = 0;
        let phase = "LOBBY";
        let targetedId = null; 

        let lastRenderState = ""; 
        let heartbeatTimer;
        let retryTimer;

        function log(t) { document.getElementById('console').innerText = `> ${t}`; }
        function showJoin() { document.getElementById('setup').classList.add('hidden'); document.getElementById('join').classList.remove('hidden'); }
        function toggleHelp() { document.getElementById('help').classList.toggle('hidden'); }

        // --- NEW: BATTLE LOG ---
        function addLog(msg, type) {
            const box = document.getElementById('battle-log');
            const div = document.createElement('div');
            div.className = 'log-entry ' + (type || 'log-neut');
            div.innerHTML = msg;
            box.prepend(div); // Add to top
        }

        function copyRoomCode() {
            if (!roomCode || roomCode === "----") return;
            navigator.clipboard.writeText(roomCode).then(() => {
                const msg = document.getElementById('copy-msg');
                msg.innerText = "COPIED!";
                setTimeout(() => msg.innerText = "", 2000);
            });
        }

        function start(mode) {
            myName = document.getElementById('my-name').value.trim() || "Warrior";
            myAvatar = document.getElementById('my-av').value.trim() || `https://api.dicebear.com/9.x/bottts/svg?seed=${myId}`;

            if (mode === 'HOST') {
                isHost = true;
                roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                // FIX: Force HP to Number type explicit
                players = [{id: myId, name: myName, avatar: myAvatar, hp: 3, maxHp: 3, dead: false, stunned: false}];
            } else {
                roomCode = document.getElementById('join-code').value.trim().toUpperCase();
                if (roomCode.length < 4) return alert("Invalid Code");
            }

            document.getElementById('setup').classList.add('hidden');
            document.getElementById('join').classList.add('hidden');
            document.getElementById('room-disp').innerText = roomCode;
            
            connect();
        }

        function connect() {
            log("Connecting...");
            client = mqtt.connect(BROKER);
            client.on('connect', () => {
                log("Connected.");
                client.subscribe(TOPIC_ROOT + roomCode);
                
                if (isHost) {
                    heartbeatTimer = setInterval(sendState, 1000);
                    render();
                } else {
                    send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                    retryTimer = setInterval(() => {
                        if (!players.find(p => p.id === myId)) {
                            log("Knocking...");
                            send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                        } else {
                            clearInterval(retryTimer);
                            log("Joined!");
                        }
                    }, 2000);
                }
            });

            client.on('message', (t, m) => {
                try {
                    const d = JSON.parse(m.toString());
                    if (d.sender !== myId) handle(d);
                } catch (e) {}
            });
        }

        function send(d) {
            d.sender = myId;
            client.publish(TOPIC_ROOT + roomCode, JSON.stringify(d));
        }

        function handle(d) {
            if (isHost) {
                if (d.type === 'JOIN') {
                    if (!players.find(p => p.id === d.id)) {
                        // FIX: Explicit Number type for HP
                        players.push({ id: d.id, name: d.name, avatar: d.avatar, hp: 3, maxHp: 3, dead: false, stunned: false });
                        addLog(`${d.name} entered the room.`, 'log-neut');
                        sendState();
                    }
                } 
                else if (d.type === 'TARGET') {
                    targetedId = d.targetId;
                    sendState();
                }
                else if (d.type === 'ATTACK') {
                    resolveCombat(d.sender, d.targetId);
                }
            } else {
                if (d.type === 'STATE') {
                    players = d.players;
                    if (turnIndex !== d.turnIndex) targetedId = null;
                    turnIndex = d.turnIndex;
                    phase = d.phase;
                    if (players[turnIndex] && players[turnIndex].id !== myId) {
                        targetedId = d.targetedId;
                    }
                    render();
                }
                else if (d.type === 'FX') {
                    showFloat(d.targetId, d.text, d.color);
                    showBigMsg(d.title, d.sub);
                    addLog(d.logMsg, d.logType); // Add to sidebar log
                }
            }
        }

        function sendState() {
            send({ type: 'STATE', players, turnIndex, phase, targetedId });
            render();
        }

        // --- LOGIC ---
        function getOutcome(roll, attName, defName) {
            const r = { dmgDef: 0, dmgAtt: 0, healAtt: 0, stunDef: false, stunAtt: false, extraTurn: false, title: "", sub: "" };
            const subReplace = (text) => text.replace(/\$1/g, defName).replace(/{user}/g, attName);

            // Log msg construction
            let logTxt = "";
            let logType = "log-neut";

            if (roll <= 40) { r.title = "HIT"; r.sub = subReplace("$1 -1 HP"); r.dmgDef = 1; logTxt = `${attName} hits ${defName}!`; logType="log-good"; } 
            else if (roll <= 70) { r.title = "BACKFIRE"; r.sub = subReplace("{user} -1 HP"); r.dmgAtt = 1; logTxt = `${attName} hurt themselves!`; logType="log-high"; }
            else if (roll <= 80) { r.title = "MISS"; r.sub = "No Effect"; logTxt = `${attName} missed.`; }
            else if (roll <= 85) { r.title = "CRIT HIT"; r.sub = subReplace("$1 -2 HP"); r.dmgDef = 2; logTxt = `CRITICAL HIT on ${defName}!`; logType="log-high"; }
            else if (roll <= 90) { r.title = "CRIT FAIL"; r.sub = subReplace("{user} -2 HP"); r.dmgAtt = 2; logTxt = `${attName} crit failed!`; logType="log-high"; }
            else if (roll <= 95) { r.title = "MUTUAL"; r.sub = "BOTH -2 HP"; r.dmgDef = 2; r.dmgAtt = 2; logTxt = `EXPLOSION! Both took damage.`; logType="log-high"; }
            else if (roll === 96) { r.title = "STUN"; r.sub = subReplace("$1 Stunned"); r.dmgDef = 1; r.stunDef = true; logTxt = `${defName} was STUNNED!`; logType="log-good"; }
            else if (roll === 97) { r.title = "SELF STUN"; r.sub = subReplace("{user} Stunned"); r.dmgAtt = 1; r.stunAtt = true; logTxt = `${attName} stunned themselves!`; }
            else if (roll === 98) { r.title = "DRAIN"; r.sub = subReplace("{user} Healed"); r.healAtt = 1; logTxt = `${attName} healed 1 HP.`; logType="log-good"; }
            else if (roll === 99) { r.title = "STEAL"; r.sub = "HP Stolen"; r.dmgDef = 1; r.healAtt = 1; logTxt = `${attName} stole life from ${defName}!`; logType="log-good"; }
            else if (roll === 100) { r.title = "ADRENALINE"; r.sub = "Go Again!"; r.dmgDef = 1; r.extraTurn = true; logTxt = `${attName} gets another turn!`; logType="log-high"; }
            
            r.logMsg = `[${roll}] ${logTxt}`;
            r.logType = logType;
            return r;
        }

        function resolveCombat(attId, defId) {
            const att = players.find(p => p.id === attId);
            const def = players.find(p => p.id === defId);
            if (!att || !def) return;

            phase = 'ROLLING';
            targetedId = defId;
            sendState();

            const roll = Math.floor(Math.random() * 100) + 1;
            const outcome = getOutcome(roll, att.name, def.name);

            setTimeout(() => {
                if (outcome.dmgDef) { def.hp -= outcome.dmgDef; if(def.hp < 0) def.hp = 0; }
                if (outcome.dmgAtt) { att.hp -= outcome.dmgAtt; if(att.hp < 0) att.hp = 0; }
                if (outcome.healAtt) { att.hp += outcome.healAtt; if(att.hp > 3) att.hp = 3; }
                
                if (def.hp === 0) def.dead = true;
                if (att.hp === 0) att.dead = true;

                if (outcome.stunDef) def.stunned = true;
                if (outcome.stunAtt) att.stunned = true;

                // Send logic results + log message
                send({ 
                    type: 'FX', targetId: defId, text: outcome.title, color: '#e94560', 
                    title: `${roll}: ${outcome.title}`, sub: outcome.sub,
                    logMsg: outcome.logMsg, logType: outcome.logType 
                });
                
                showFloat(defId, outcome.title, '#e94560');
                showBigMsg(`${roll}: ${outcome.title}`, outcome.sub);
                addLog(outcome.logMsg, outcome.logType);

            }, 1000);

            setTimeout(() => {
                targetedId = null;
                const alive = players.filter(p => !p.dead);
                if (alive.length <= 1) {
                    phase = 'GAMEOVER';
                    if(alive.length === 1) launchConfetti();
                }
                else {
                    if (!outcome.extraTurn) {
                        let i = 0;
                        do {
                            turnIndex = (turnIndex + 1) % players.length;
                            const p = players[turnIndex];
                            if (!p.dead && p.stunned) { 
                                p.stunned = false; 
                                addLog(`${p.name} is recovering from stun...`, 'log-neut');
                            } else { /* Valid */ }
                            i++;
                        } while ((players[turnIndex].dead || players[turnIndex].stunned) && i < 20);
                        
                        players.forEach((p, idx) => { if(idx !== turnIndex && !p.dead) p.stunned = false; });
                    }
                    phase = 'IDLE';
                }
                sendState();
            }, 4000);
        }

        function clickPlayer(id) {
            if (phase !== 'IDLE') return;
            const turnP = players[turnIndex];
            if (!turnP || turnP.id !== myId) return;
            if (id === myId) return;
            
            const t = players.find(p => p.id === id);
            if (!t || t.dead) return;

            targetedId = id;
            if (isHost) sendState();
            else send({ type: 'TARGET', targetId: id });
            render();
        }

        function confirmAction() {
            if (isHost && phase === 'LOBBY') {
                if (players.length < 2) return alert("Need 2 players");
                phase = 'IDLE';
                addLog("GAME STARTED", "log-high");
                sendState();
                return;
            }
            if (phase === 'GAMEOVER') { location.reload(); return; }
            if (phase === 'IDLE' && targetedId) {
                if (isHost) resolveCombat(myId, targetedId);
                else send({ type: 'ATTACK', targetId: targetedId });
                phase = 'ROLLING'; 
                render();
            }
        }

        function launchConfetti() {
            var end = Date.now() + 3000;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function showBigMsg(t, s) {
            const el = document.getElementById('roll-display');
            el.innerHTML = `<div>${t}</div><div class="roll-sub">${s}</div>`;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 3500);
        }

        function showFloat(id, txt, col) {
            const el = document.getElementById(`av-${id}`);
            if(!el) return;
            const f = document.createElement('div');
            f.className = 'floater'; f.innerText=txt; f.style.color=col;
            el.appendChild(f);
            setTimeout(()=>f.remove(), 2000);
        }

        function render() {
            const currentState = JSON.stringify({ players, turnIndex, phase, targetedId, myId });
            if (currentState === lastRenderState) return; 
            lastRenderState = currentState;

            const list = document.getElementById('player-list');
            const arena = document.getElementById('arena-layer');
            const bar = document.getElementById('top-bar');
            const btn = document.getElementById('btn-act');

            list.innerHTML = '';
            arena.innerHTML = '';

            const turnP = players[turnIndex] || {};
            const isMyTurn = turnP.id === myId;

            if (phase === 'LOBBY') {
                bar.innerText = `LOBBY: ${players.length} WARRIORS`;
                btn.innerHTML = "▶";
                btn.disabled = !isHost;
                btn.style.opacity = isHost ? 1 : 0.5;
            } else if (phase === 'GAMEOVER') {
                const w = players.find(p => !p.dead);
                bar.innerText = `WINNER: ${w?w.name:'NONE'}`;
                btn.innerHTML = "↺";
                btn.disabled = false;
                btn.style.opacity = 1;
                btn.onclick = () => location.reload();
                launchConfetti(); 
            } else if (phase === 'ROLLING') {
                bar.innerText = "ROLLING D100...";
                btn.disabled = true;
                btn.style.opacity = 0;
            } else {
                if (isMyTurn) {
                    bar.innerText = targetedId ? "CONFIRM ATTACK" : "YOUR TURN";
                    bar.style.color = targetedId ? "#f1c40f" : "#2ecc71";
                    btn.innerHTML = "✓";
                    btn.disabled = !targetedId;
                    btn.style.opacity = targetedId ? 1 : 0.3;
                } else {
                    bar.innerText = `${turnP.name}'S TURN`;
                    bar.style.color = "#fff";
                    btn.disabled = true;
                    btn.style.opacity = 0;
                }
            }

            const radius = 200;
            players.forEach((p, i) => {
                const isTarget = (targetedId === p.id);
                const isTurn = (i === turnIndex);
                const canClick = (phase==='IDLE' && isMyTurn && !p.dead && p.id!==myId);

                let dots = '';
                // Ensure p.hp is a number to avoid loops failing
                const hpVal = Number(p.hp);
                for(let h=0; h<3; h++) dots += `<span class="hp-dot ${h<hpVal?'on':''}"></span>`;
                
                const card = document.createElement('div');
                card.className = `player-card ${p.dead?'dead':''} ${p.stunned?'stunned':''}`;
                if(canClick) card.classList.add('clickable');
                if(isTurn) card.classList.add('active');
                if(isTarget) card.classList.add('target');
                
                card.onclick = () => clickPlayer(p.id);
                card.innerHTML = `<img src="${p.avatar}" class="avatar"><div class="card-info"><div style="font-weight:bold">${p.name} <span class="status-badge">STUNNED</span></div><div class="hp-container">${dots}</div></div>`;
                list.appendChild(card);

                if (!p.dead) {
                    const a = (i * (360/players.length)) - 90;
                    const rad = a * (Math.PI/180);
                    const x = Math.cos(rad)*radius; 
                    const y = Math.sin(rad)*radius;

                    const el = document.createElement('div');
                    el.className = `arena-p ${p.dead?'dead':''}`;
                    if(canClick) el.classList.add('clickable');
                    if(isTurn) el.classList.add('active');
                    if(isTarget) el.classList.add('target');
                    
                    el.style.left = `calc(50% + ${x}px)`;
                    el.style.top = `calc(50% + ${y}px)`;
                    el.id = `av-${p.id}`;
                    el.onclick = () => clickPlayer(p.id);
                    
                    el.innerHTML = `<img src="${p.avatar}" class="arena-av"><div class="arena-name">${p.name}</div>`;
                    arena.appendChild(el);
                }
            });
        }

        window.addEventListener('resize', () => { lastRenderState=""; render(); });

    </script>
</body>
</html>
