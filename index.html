<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Straddle Royale V9</title>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Bangers&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-overlay: rgba(0, 0, 0, 0.4);
            --panel-bg: rgba(15, 15, 20, 0.95);
            --highlight: #e94560;
            --accent: #f1c40f;
            --text-main: #ffffff;
            --green: #2ecc71;
            /* New Comic Colors */
            --comic-yellow: #fff9c4;
            --comic-text: #000;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0;
            height: 100vh;
            background-image: url('https://raw.githubusercontent.com/TreeStevens/straddle/main/1764034175005.png'); 
            background-size: cover;
            background-position: center;
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            display: flex;
        }

        body::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-overlay); z-index: -1;
        }

        /* --- SIDEBAR (Now Comic Strip Style) --- */
        #sidebar {
            width: 380px;
            background: var(--panel-bg);
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 20;
            box-shadow: 10px 0 30px #000;
        }

        .logo {
            font-family: 'Anton', sans-serif;
            font-size: 36px;
            color: var(--highlight);
            text-transform: uppercase;
            line-height: 1;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 #000;
            text-align: center;
        }

        .code-box {
            background: #000; border: 1px solid #444; padding: 10px;
            text-align: center; margin-bottom: 15px; border-radius: 4px;
            cursor: pointer; transition: 0.2s;
        }
        .code-box:hover { border-color: var(--accent); }
        .code-val { font-family: 'Anton', sans-serif; font-size: 32px; color: var(--accent); letter-spacing: 2px; }
        
        #player-list { 
            flex-shrink: 0; /* Don't shrink */
            margin-bottom: 15px;
            display: flex; flex-direction: column; gap: 5px;
        }

        /* --- NEW COMIC LOG --- */
        #battle-log {
            flex-grow: 1;
            background: #000;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* Newest at bottom */
            gap: 15px;
        }

        .comic-entry {
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            position: relative;
        }

        .comic-bubble {
            background: #fff;
            color: #000;
            padding: 8px 12px;
            border-radius: 12px;
            border-bottom-left-radius: 2px;
            font-family: 'Bangers', cursive;
            font-size: 16px;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: inline-block;
            position: relative;
        }
        
        .narrator-box {
            background: var(--comic-yellow);
            color: #000;
            border: 2px solid #000;
            padding: 5px 8px;
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            font-size: 13px;
            text-transform: uppercase;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
        }
        .narrator-box.bad { background: #ffcccc; color: #900; }
        .narrator-box.good { background: #ccffcc; color: #060; }
        .narrator-box.crit { background: var(--accent); color: #000; border: 2px dashed #000; }

        /* CARDS */
        .player-card {
            background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 6px;
            display: flex; align-items: center; gap: 10px; border: 2px solid transparent; transition: 0.1s;
        }
        .player-card.clickable:hover { background: rgba(255, 255, 255, 0.15); cursor: pointer; border-color: #fff; }
        .player-card.active { border-color: var(--green); background: rgba(46, 204, 113, 0.1); }
        .player-card.target { border-color: var(--highlight) !important; background: rgba(233, 69, 96, 0.2) !important; }
        .player-card.dead { opacity: 0.4; filter: grayscale(1); }
        .player-card.stunned { border-color: #a29bfe; }

        .avatar { width: 35px; height: 35px; border-radius: 4px; background: #000; border: 1px solid #555; pointer-events: none; object-fit: cover; }
        .card-info { flex-grow: 1; pointer-events: none; font-size: 13px; }
        .hp-dot { width: 8px; height: 8px; background: #222; border-radius: 50%; border: 1px solid #444; display: inline-block; margin-right: 2px;}
        .hp-dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); border-color: var(--green); }
        .status-badge { font-size: 9px; padding: 1px 3px; border-radius: 3px; background: #a29bfe; color: #000; font-weight: bold; margin-left: 5px; display: none; }
        .stunned .status-badge { display: inline-block; }

        /* ARENA */
        #arena { flex-grow: 1; position: relative; display: flex; justify-content: center; align-items: center; perspective: 1000px; }
        
        #top-bar {
            position: absolute; top: 20px; background: rgba(0,0,0,0.8); padding: 8px 25px;
            border-radius: 30px; font-weight: bold; border: 1px solid #555;
            font-size: 1.2rem; z-index: 10;
        }

        /* COMIC BUBBLE (In Arena) */
        .bubble {
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 12px 18px; border-radius: 20px;
            font-family: 'Bangers', cursive; font-size: 22px; letter-spacing: 1px;
            white-space: nowrap; z-index: 100; pointer-events: none;
            border: 2px solid #000;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5); 
            opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }
        .bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 50%;
            border-width: 10px 10px 0; border-style: solid; border-color: #000 transparent;
            transform: translateX(-50%);
        }
        .bubble::before { /* Inner white triangle for border effect */
            content: ''; position: absolute; bottom: -6px; left: 50%;
            border-width: 8px 8px 0; border-style: solid; border-color: #fff transparent;
            transform: translateX(-50%); z-index: 1;
        }
        .bubble.show { opacity: 1; transform: translateX(-50%) scale(1); }

        /* EXPOSITION COMIC BOX (Center) */
        #comic-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 80%; max-width: 600px;
            background: var(--comic-yellow); 
            border: 4px solid #000;
            padding: 25px; text-align: center;
            box-shadow: 20px 20px 0px rgba(0,0,0,0.8);
            z-index: 200; 
            display: none; /* Physically hidden to prevent empty flash */
            pointer-events: none;
        }
        #comic-panel.visible { display: block; animation: panelPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes panelPop { 0% { transform: translate(-50%, -50%) scale(0); } 100% { transform: translate(-50%, -50%) scale(1); } }

        .comic-title {
            font-family: 'Bangers', cursive; font-size: 64px; color: #e94560;
            margin: 0 0 15px 0; line-height: 1; letter-spacing: 2px;
            text-shadow: 3px 3px 0px #000; -webkit-text-stroke: 1px black;
        }
        .comic-text {
            font-family: 'Roboto', sans-serif; font-size: 26px; color: #000;
            font-weight: 900; line-height: 1.3;
        }

        .arena-p {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            width: 120px; transition: transform 0.5s; z-index: 5; margin-left: -60px; margin-top: -60px;
        }
        .arena-av {
            width: 110px; height: 110px; border-radius: 50%; border: 4px solid #333;
            background: #000; transition: 0.2s; pointer-events: none; box-shadow: 0 10px 20px rgba(0,0,0,0.7);
            object-fit: cover;
        }
        
        .arena-p.clickable:hover .arena-av { transform: scale(1.1); border-color: #fff; cursor: pointer; }
        .arena-p.active .arena-av { border-color: var(--green); box-shadow: 0 0 30px var(--green); transform: scale(1.1); }
        .arena-p.target .arena-av { border-color: var(--highlight); box-shadow: 0 0 40px var(--highlight); animation: shake 0.5s infinite; }
        .arena-p.dead { opacity: 0; transition: opacity 1s; pointer-events: none; }
        .arena-name {
            background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 4px;
            margin-top: 8px; font-weight: bold; pointer-events: none;
        }

        /* CONTROLS */
        #action-area { 
            position: absolute; bottom: 30px; width: 100%; 
            display: flex; justify-content: center; align-items: center; gap: 10px;
            z-index: 50;
        }
        
        #attack-input {
            background: rgba(0,0,0,0.8); border: 2px solid #555;
            color: white; padding: 15px; border-radius: 30px;
            width: 400px; font-size: 18px; outline: none;
            text-align: center; display: none;
        }
        #attack-input:focus { border-color: var(--highlight); }

        .btn-big {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff;
            background: var(--highlight); color: #fff; font-size: 40px; font-weight: bold;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.8); transition: 0.2s;
        }
        .btn-big:hover { transform: scale(1.1); background: #ff6b81; }
        .btn-big:disabled { background: #555; border-color: #777; opacity: 0.5; pointer-events: none; }

        /* MODALS */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: #fff; color: #000; padding: 40px; border-radius: 8px; width: 450px; text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #000; font-size: 1.2rem; text-align: center; font-weight: bold; text-transform: uppercase; }
        .btn-main { width: 100%; padding: 15px; background: #000; color: #fff; font-weight: bold; cursor: pointer; font-size: 1.2rem; margin-top: 10px; }
        .btn-main:hover { background: var(--highlight); }

        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .floater { position: absolute; font-size: 40px; font-weight: 900; animation: float 2s forwards; pointer-events: none; text-shadow: 2px 2px #000; z-index: 100; white-space: nowrap; }
        @keyframes float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo">STRADDLE<br>ROYALE V9</div>
        <div class="code-box" onclick="copyRoomCode()">
            <div style="color:#888; font-size:12px;">ROOM CODE</div>
            <div class="code-val" id="room-disp">----</div>
            <div class="copy-hint" id="copy-msg"></div>
        </div>
        <div id="player-list"></div>
        <div id="battle-log">
            <div style="color:#555; text-align:center;">Waiting for battle...</div>
        </div>
        <button class="btn-main" style="background:transparent; border:1px solid #555; color:#aaa; margin-top:10px; padding: 10px; font-size: 14px;" onclick="toggleHelp()">RULES</button>
    </div>

    <div id="arena">
        <div id="top-bar">INITIALIZING...</div>
        
        <!-- COMIC EXPOSITION BOX -->
        <div id="comic-panel">
            <div class="comic-title" id="comic-title">CRITICAL HIT!</div>
            <div class="comic-text" id="comic-body">...</div>
        </div>

        <div id="arena-layer"></div>
        
        <div id="action-area">
            <input type="text" id="attack-input" placeholder="describe action (no subject, 3rd person)">
            <button id="btn-act" class="btn-big" disabled onclick="confirmAction()">✓</button>
        </div>
    </div>

    <!-- SETUP -->
    <div id="setup" class="modal-wrap">
        <div class="modal">
            <h1 style="margin:0 0 20px 0; font-family:'Anton'; font-size:40px;">WELCOME</h1>
            <input type="text" id="my-name" placeholder="NAME" maxlength="10">
            <input type="text" id="my-av" placeholder="AVATAR URL (OPTIONAL)">
            <button class="btn-main" onclick="start('HOST')">HOST GAME</button>
            <button class="btn-main" style="background:#555" onclick="showJoin()">JOIN GAME</button>
        </div>
    </div>

    <div id="join" class="modal-wrap hidden">
        <div class="modal">
            <h1>JOIN ROOM</h1>
            <input type="text" id="join-code" placeholder="ABCD">
            <button class="btn-main" onclick="start('JOIN')">CONNECT</button>
            <button class="btn-main" style="background:#ccc; color:#000" onclick="location.reload()">BACK</button>
        </div>
    </div>

    <div id="help" class="modal-wrap hidden">
        <div class="modal">
            <div class="close-modal" onclick="toggleHelp()">×</div>
            <h2>RULES</h2>
            <div style="text-align:left; font-size:13px; line-height:1.5;">
                <p>1-40: Hit (-1)</p>
                <p>41-70: Backfire (Self -1)</p>
                <p>71-80: Miss</p>
                <p>81-85: Crit (-2)</p>
                <p>86-90: Bad Luck (Self -2)</p>
                <p>91-95: Mutual (-2 Both)</p>
                <p>96/97: Stun</p>
                <p>98-100: Special</p>
            </div>
            <button class="btn-main" onclick="toggleHelp()">GOT IT</button>
        </div>
    </div>

    <script>
        const BROKER = 'wss://broker.emqx.io:8084/mqtt';
        const TOPIC_ROOT = 'straddle-v9-final/';

        // --- FLAVOR TEXT DB ---
        const FLAVOR_TEXTS = {
            1: "$1 loved it so they lose a point!",
            41: "$1 was so into it that {user} was surprised and loses a point!",
            71: "they both loved it, nobody loses a point!",
            81: "they loved it so much that they could not control themselves and lost TWO points",
            86: "{user} should not have edged so much on their way over - they lose TWO points",
            91: "the passion generated between them was so great they both got heat stroke and EACH lose TWO points",
            96: "they were so into it they LOST A POINT and need to rest so $1 also LOSES THEIR NEXT TURN.",
            97: "{user} put so much into their move they overheated, lost a point and lose their next turn.",
            98: "they sucked the incredibly sexy energy out of {user} and GAIN a point!",
            99: "they were so grateful for the pleasure they took one of their points and gave it to {user}!",
            100: "they felt it deep in their soul. Not only does $1 lose a point but {user} gets to GO AGAIN!"
        };

        function getFlavorText(roll) {
            if(roll <= 40) return "$1 loved it so they lose a point!";
            if(roll <= 70) return "$1 was so into it that {user} was surprised and loses a point!";
            if(roll <= 80) return "It was pretty awkward... nobody loses a point.";
            if(roll <= 85) return "They loved it so much they lost TWO points!";
            if(roll <= 90) return "{user} got overheated and lost TWO points!";
            if(roll <= 95) return "Mutual destruction! BOTH lose TWO points!";
            return FLAVOR_TEXTS[roll] || "Something happened!";
        }

        let client;
        let myId = Math.random().toString(36).substr(2, 8);
        let myName = "Player";
        let myAvatar = "";
        let roomCode = "";
        let isHost = false;

        let players = [];
        let turnIndex = 0;
        let phase = "LOBBY";
        let targetedId = null; 

        let lastRenderState = ""; 
        let heartbeatTimer;
        let retryTimer;

        function showJoin() { document.getElementById('setup').classList.add('hidden'); document.getElementById('join').classList.remove('hidden'); }
        function toggleHelp() { document.getElementById('help').classList.toggle('hidden'); }

        // --- NEW COMIC LOGIC ---
        function addLog(actorName, bubbleText, outcomeText, type) {
            const box = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'comic-entry';
            
            // Comic Bubble Part
            let html = `
                <div>
                    <div class="comic-bubble">${actorName}: ${bubbleText}</div>
                </div>
            `;
            
            // Narrator Box Part
            if(outcomeText) {
                let colorClass = 'narrator-box';
                if(type === 'log-bad') colorClass += ' bad';
                if(type === 'log-good') colorClass += ' good';
                if(type === 'log-crit') colorClass += ' crit';
                html += `<div class="${colorClass}">${outcomeText}</div>`;
            }

            entry.innerHTML = html;
            box.prepend(entry);
        }

        function copyRoomCode() {
            if (!roomCode || roomCode === "----") return;
            navigator.clipboard.writeText(roomCode).then(() => {
                const msg = document.getElementById('copy-msg');
                msg.innerText = "COPIED!";
                setTimeout(() => msg.innerText = "", 2000);
            });
        }

        function start(mode) {
            myName = document.getElementById('my-name').value.trim() || "Warrior";
            myAvatar = document.getElementById('my-av').value.trim() || `https://api.dicebear.com/9.x/bottts/svg?seed=${myId}`;

            if (mode === 'HOST') {
                isHost = true;
                roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                players = [{id: myId, name: myName, avatar: myAvatar, hp: 3, maxHp: 3, dead: false, stunned: false}];
            } else {
                roomCode = document.getElementById('join-code').value.trim().toUpperCase();
                if (roomCode.length < 4) return alert("Invalid Code");
            }

            document.getElementById('setup').classList.add('hidden');
            document.getElementById('join').classList.add('hidden');
            document.getElementById('room-disp').innerText = roomCode;
            
            connect();
        }

        function connect() {
            client = mqtt.connect(BROKER);
            client.on('connect', () => {
                client.subscribe(TOPIC_ROOT + roomCode);
                if (isHost) {
                    heartbeatTimer = setInterval(sendState, 1000);
                    render();
                } else {
                    send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                    retryTimer = setInterval(() => {
                        if (!players.find(p => p.id === myId)) send({ type: 'JOIN', id: myId, name: myName, avatar: myAvatar });
                        else clearInterval(retryTimer);
                    }, 2000);
                }
            });

            client.on('message', (t, m) => {
                try {
                    const d = JSON.parse(m.toString());
                    if (d.sender !== myId) handle(d);
                } catch (e) {}
            });
        }

        function send(d) {
            d.sender = myId;
            client.publish(TOPIC_ROOT + roomCode, JSON.stringify(d));
        }

        function handle(d) {
            if (isHost) {
                if (d.type === 'JOIN') {
                    if (!players.find(p => p.id === d.id)) {
                        players.push({ id: d.id, name: d.name, avatar: d.avatar, hp: 3, maxHp: 3, dead: false, stunned: false });
                        addLog("NARRATOR", "New Challenger!", `${d.name} entered the arena.`);
                        sendState();
                    }
                } 
                else if (d.type === 'TARGET') {
                    targetedId = d.targetId;
                    sendState();
                }
                else if (d.type === 'ATTACK') {
                    resolveCombat(d.sender, d.targetId, d.flavor);
                }
            } else {
                if (d.type === 'STATE') {
                    players = d.players;
                    if (turnIndex !== d.turnIndex) targetedId = null;
                    turnIndex = d.turnIndex;
                    phase = d.phase;
                    if (players[turnIndex] && players[turnIndex].id !== myId) targetedId = d.targetedId;
                    render();
                }
                else if (d.type === 'FX') {
                    showFloat(d.targetId, d.text, d.color);
                    showComic(d.title, d.sub); // Show Exposition
                    addLog(d.attName, d.flavor, d.sub, d.logType); // Show Comic Strip
                    if(d.flavor && d.attId) showBubble(d.attId, d.flavor, d.targetName);
                }
            }
        }

        function sendState() {
            send({ type: 'STATE', players, turnIndex, phase, targetedId });
            render();
        }

        // --- D100 LOGIC ---
        function getOutcome(roll, attName, defName, flavor) {
            const r = { dmgDef: 0, dmgAtt: 0, healAtt: 0, stunDef: false, stunAtt: false, extraTurn: false, title: "", sub: "" };
            const rawText = getFlavorText(roll);
            const resText = rawText.replace(/\$1/g, defName).replace(/{user}/g, attName);
            
            // Clean up flavor text (ensure it has punctuation)
            let f = flavor || "attacks";
            
            if (roll <= 40) { r.title = "HIT!"; r.dmgDef = 1; r.logType="log-hit"; } 
            else if (roll <= 70) { r.title = "BACKFIRE!"; r.dmgAtt = 1; r.logType="log-bad"; }
            else if (roll <= 80) { r.title = "MISS"; }
            else if (roll <= 85) { r.title = "CRITICAL HIT!"; r.dmgDef = 2; r.logType="log-crit"; }
            else if (roll <= 90) { r.title = "CRIT FAIL!"; r.dmgAtt = 2; r.logType="log-bad"; }
            else if (roll <= 95) { r.title = "MUTUAL HIT!"; r.dmgDef = 2; r.dmgAtt = 2; r.logType="log-bad"; }
            else if (roll === 96) { r.title = "STUNNED!"; r.dmgDef = 1; r.stunDef = true; r.logType="log-hit"; }
            else if (roll === 97) { r.title = "SELF STUN!"; r.dmgAtt = 1; r.stunAtt = true; r.logType="log-bad"; }
            else if (roll === 98) { r.title = "DRAIN!"; r.healAtt = 1; r.logType="log-hit"; }
            else if (roll === 99) { r.title = "STEAL!"; r.dmgDef = 1; r.healAtt = 1; r.logType="log-crit"; }
            else if (roll === 100) { r.title = "ADRENALINE!"; r.dmgDef = 1; r.extraTurn = true; r.logType="log-crit"; }
            
            r.sub = resText;
            r.flavor = f; // Pass back cleaned flavor
            return r;
        }

        function resolveCombat(attId, defId, flavor) {
            const att = players.find(p => p.id === attId);
            const def = players.find(p => p.id === defId);
            if (!att || !def) return;

            phase = 'ROLLING';
            targetedId = defId;
            sendState();

            const roll = Math.floor(Math.random() * 100) + 1;
            const outcome = getOutcome(roll, att.name, def.name, flavor);

            // Phase 1: Thought Bubble
            send({ type: 'FX', targetId: null, text: '', color: '', title: '', sub: '', flavor: outcome.flavor, attId: attId, targetName: def.name, attName: att.name });
            showBubble(attId, outcome.flavor, def.name);

            // Phase 2: Comic Box Result
            setTimeout(() => {
                if (outcome.dmgDef) { def.hp -= outcome.dmgDef; if(def.hp < 0) def.hp = 0; }
                if (outcome.dmgAtt) { att.hp -= outcome.dmgAtt; if(att.hp < 0) att.hp = 0; }
                if (outcome.healAtt) { att.hp += outcome.healAtt; if(att.hp > 3) att.hp = 3; }
                
                if (def.hp === 0) def.dead = true;
                if (att.hp === 0) att.dead = true;

                if (outcome.stunDef) def.stunned = true;
                if (outcome.stunAtt) att.stunned = true;

                const color = outcome.dmgDef > 0 ? '#e94560' : '#fff';

                send({ 
                    type: 'FX', targetId: defId, text: outcome.title, color: color, 
                    title: `${roll}: ${outcome.title}`, sub: outcome.sub,
                    logType: outcome.logType, flavor: outcome.flavor, attName: att.name
                });
                
                showFloat(defId, outcome.title, color);
                showComic(outcome.title + ` (${roll})`, outcome.sub);
                addLog(att.name, outcome.flavor, outcome.sub, outcome.logType);

            }, 2000); 

            // Phase 3: Next Turn
            setTimeout(() => {
                targetedId = null;
                const alive = players.filter(p => !p.dead);
                if (alive.length <= 1) {
                    phase = 'GAMEOVER';
                    if(alive.length === 1) launchWhiteLiquid(); // WHITE LIQUID VICTORY
                }
                else {
                    if (!outcome.extraTurn) {
                        let i = 0;
                        do {
                            turnIndex = (turnIndex + 1) % players.length;
                            const p = players[turnIndex];
                            if (!p.dead && p.stunned) { 
                                p.stunned = false; 
                                addLog(p.name, "is stunned!", "SKIP TURN", "log-neut");
                            } else { /* Valid */ }
                            i++;
                        } while ((players[turnIndex].dead || players[turnIndex].stunned) && i < 20);
                        
                        players.forEach((p, idx) => { if(idx !== turnIndex && !p.dead) p.stunned = false; });
                    }
                    phase = 'IDLE';
                }
                sendState();
            }, 7000); 
        }

        function clickPlayer(id) {
            if (phase !== 'IDLE') return;
            const turnP = players[turnIndex];
            if (!turnP || turnP.id !== myId) return;
            if (id === myId) return;
            
            const t = players.find(p => p.id === id);
            if (!t || t.dead) return;

            targetedId = id;
            if (isHost) sendState();
            else send({ type: 'TARGET', targetId: id });
            render();
        }

        function confirmAction() {
            if (isHost && phase === 'LOBBY') {
                if (players.length < 2) return alert("Need 2 players");
                phase = 'IDLE';
                addLog("NARRATOR", "Let the games begin!", "FIGHT!");
                sendState();
                return;
            }
            if (phase === 'GAMEOVER') { location.reload(); return; }
            if (phase === 'IDLE' && targetedId) {
                const txt = document.getElementById('attack-input').value;
                document.getElementById('attack-input').value = ""; 

                if (isHost) resolveCombat(myId, targetedId, txt);
                else send({ type: 'ATTACK', targetId: targetedId, flavor: txt });
                
                phase = 'ROLLING'; 
                render();
            }
        }

        // --- VISUALS ---
        function launchWhiteLiquid() {
            var end = Date.now() + 3000;
            // WHITE COLORS ONLY
            var colors = ['#ffffff', '#eeeeee', '#f0f0f0'];

            (function frame() {
                // Left Cannon
                confetti({ 
                    particleCount: 4, angle: 60, spread: 55, origin: { x: 0, y: 1 }, 
                    colors: colors, gravity: 2, drift: 0, ticks: 300, startVelocity: 60, shapes: ['circle'] 
                });
                // Right Cannon
                confetti({ 
                    particleCount: 4, angle: 120, spread: 55, origin: { x: 1, y: 1 }, 
                    colors: colors, gravity: 2, drift: 0, ticks: 300, startVelocity: 60, shapes: ['circle'] 
                });

                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function showComic(t, s) {
            const el = document.getElementById('comic-panel');
            document.getElementById('comic-title').innerText = t;
            document.getElementById('comic-body').innerText = s;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), 4800);
        }

        function showFloat(id, txt, col) {
            const el = document.getElementById(`av-${id}`);
            if(!el) return;
            const f = document.createElement('div');
            f.className = 'floater'; f.innerText=txt; f.style.color=col;
            el.appendChild(f);
            setTimeout(()=>f.remove(), 2000);
        }

        function showBubble(id, text, targetName) {
            if(!text) return;
            const el = document.getElementById(`bubble-${id}`);
            if(!el) return;
            // Append target name automatically
            const fullText = text + " " + targetName + "...";
            el.innerText = fullText;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        function render() {
            const currentState = JSON.stringify({ players, turnIndex, phase, targetedId, myId });
            if (currentState === lastRenderState) return; 
            lastRenderState = currentState;

            const list = document.getElementById('player-list');
            const arena = document.getElementById('arena-layer');
            const bar = document.getElementById('top-bar');
            const btn = document.getElementById('btn-act');
            const inp = document.getElementById('attack-input');

            list.innerHTML = '';
            arena.innerHTML = '';

            const turnP = players[turnIndex] || {};
            const isMyTurn = turnP.id === myId;

            inp.style.display = 'none'; 

            if (phase === 'LOBBY') {
                bar.innerText = `LOBBY: ${players.length} WARRIORS`;
                btn.innerHTML = "▶";
                btn.disabled = !isHost;
                btn.style.opacity = isHost ? 1 : 0.5;
            } else if (phase === 'GAMEOVER') {
                const w = players.find(p => !p.dead);
                bar.innerText = `WINNER: ${w?w.name:'NONE'}`;
                btn.innerHTML = "↺";
                btn.disabled = false;
                btn.style.opacity = 1;
                btn.onclick = () => location.reload();
                launchWhiteLiquid(); // Client Side
            } else if (phase === 'ROLLING') {
                bar.innerText = "ROLLING...";
                btn.disabled = true;
                btn.style.opacity = 0;
            } else {
                if (isMyTurn) {
                    if(targetedId) {
                        bar.innerText = "TYPE ACTION & FIRE";
                        btn.innerHTML = "✓";
                        btn.disabled = false;
                        btn.style.opacity = 1;
                        inp.style.display = 'block'; 
                        inp.focus();
                    } else {
                        bar.innerText = "YOUR TURN - SELECT TARGET";
                        bar.style.color = "#2ecc71";
                        btn.disabled = true;
                        btn.style.opacity = 0.3;
                    }
                } else {
                    bar.innerText = `${turnP.name}'S TURN`;
                    bar.style.color = "#fff";
                    btn.disabled = true;
                    btn.style.opacity = 0;
                }
            }

            const radius = 220;
            players.forEach((p, i) => {
                const isTarget = (targetedId === p.id);
                const isTurn = (i === turnIndex);
                const canClick = (phase==='IDLE' && isMyTurn && !p.dead && p.id!==myId);

                let dots = '';
                const hpVal = Number(p.hp);
                for(let h=0; h<3; h++) dots += `<span class="hp-dot ${h<hpVal?'on':''}"></span>`;
                
                const card = document.createElement('div');
                card.className = `player-card ${p.dead?'dead':''} ${p.stunned?'stunned':''}`;
                if(canClick) card.classList.add('clickable');
                if(isTurn) card.classList.add('active');
                if(isTarget) card.classList.add('target');
                card.onclick = () => clickPlayer(p.id);
                card.innerHTML = `<img src="${p.avatar}" class="avatar"><div class="card-info"><div style="font-weight:bold">${p.name} <span class="status-badge">STUNNED</span></div><div class="hp-container">${dots}</div></div>`;
                list.appendChild(card);

                if (!p.dead) {
                    const a = (i * (360/players.length)) - 90;
                    const rad = a * (Math.PI/180);
                    const x = Math.cos(rad)*radius; 
                    const y = Math.sin(rad)*radius;

                    const el = document.createElement('div');
                    el.className = `arena-p ${p.dead?'dead':''}`;
                    if(canClick) el.classList.add('clickable');
                    if(isTurn) el.classList.add('active');
                    if(isTarget) el.classList.add('target');
                    
                    el.style.left = `calc(50% + ${x}px)`;
                    el.style.top = `calc(50% + ${y}px)`;
                    el.id = `av-${p.id}`;
                    el.onclick = () => clickPlayer(p.id);
                    
                    el.innerHTML = `
                        <div class="bubble" id="bubble-${p.id}"></div>
                        <img src="${p.avatar}" class="arena-av">
                        <div class="arena-name">${p.name}</div>
                    `;
                    arena.appendChild(el);
                }
            });
        }

        window.addEventListener('resize', () => { lastRenderState=""; render(); });

    </script>
</body>
</html>
